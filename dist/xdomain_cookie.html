<!DOCTYPE html>
<html>
<head>
</head>
<body>
<script>
    "use strict";

    function LocalStorageStore() {

        // Declaration

        return {
            get: get,
            set: set,
            has: has
        };

        // Implementation

        function set(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                return false;
            }
        }

        function get(key) {
            if (!key) {
                return null;
            }

            try {
                return JSON.parse(localStorage.getItem(key));
            } catch (e) {
                return null;
            }
        }

        function has(key) {
            try {
                return localStorage.getItem(key) !== null;
            } catch (e) {
                return false;
            }
        }
    }

    function CookieStore() {

        // Declaration

        return {
            get: get,
            set: set,
            has: has
        };

        // Implementation

        function get(key) {
            if (!key) {
                return null;
            }
            return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(key).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
        }

        function set(key, value, vEnd, sPath, sDomain, bSecure) {
            if (!key || /^(?:expires|max\-age|path|domain|secure)$/i.test(key)) {
                return;
            }
            var sExpires = "";
            if (vEnd) {
                switch (vEnd.constructor) {
                    case Number:
                        sExpires = vEnd === Infinity ? "; expires=Fri, 31 Dec 9999 23:59:59 GMT" : "; max-age=" + vEnd;
                        /*
                        Note: Despite officially defined in RFC 6265, the use of `max-age` is not compatible with any
                        version of Internet Explorer, Edge and some mobile browsers. Therefore passing a number to
                        the end parameter might not work as expected. A possible solution might be to convert the the
                        relative time to an absolute time. For instance, replacing the previous line with:
                        */
                        /*
                        sExpires = vEnd === Infinity ? "; expires=Fri, 31 Dec 9999 23:59:59 GMT" : "; expires=" + (new Date(vEnd * 1e3 + Date.now())).toUTCString();
                        */
                        break;
                    case String:
                        sExpires = "; expires=" + vEnd;
                        break;
                    case Date:
                        sExpires = "; expires=" + vEnd.toUTCString();
                        break;
                }
            }
            document.cookie = encodeURIComponent(key) + "=" + encodeURIComponent(value) + sExpires + (sDomain ? "; domain=" + sDomain : "") + (sPath ? "; path=" + sPath : "") + (bSecure ? "; secure" : "");
        }

        function has(key) {
            if (!key || /^(?:expires|max\-age|path|domain|secure)$/i.test(key)) {
                return false;
            }
            return (new RegExp("(?:^|;\\s*)" + encodeURIComponent(key).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=")).test(document.cookie);
        }
    }

    function ParentCommunicator(cookieStore, localStore) {

        // origin & namespace data is passed in via urlencoded json object in url hash
        var _hash_data = JSON.parse(decodeURIComponent(window.location.hash.substr(1))),
            _namespace = _hash_data.namespace,
            _window_origin = _hash_data.window_origin,
            _iframe_origin = _hash_data.iframe_origin,
            _debug = _hash_data.debug;

        return {
            listen: listen,
            sendDataToParent: sendDataToParent
        };

        // Implementation

        function listen() {
            //listen for incoming postMessage requests (to write cookie, incoming from local page that loaded iframe)
            window.addEventListener('message', onIncomingMessage);
        }

        function onIncomingMessage(event) {

            // Verify this is a message for us.

            var origin = event.origin || event.originalEvent.origin; // For Chrome, the origin property is in the event.originalEvent object.
            if ([_window_origin, _iframe_origin].indexOf(origin) === -1) return; //incoming message not from iframe page

            //We must filter messages here to verify that it's the specific message/type we are looking for, and not from another script
            var data = null;
            try {
                data = JSON.parse(event.data);
            } catch (e) {
            }

            if (typeof data !== 'object' || (data instanceof Array)) return; //data is not a non-array object
            if (!('msg_type' in data) || data.msg_type !== 'xdsc_write') return; //data is not a xdomainc-cookie payload
            if (!('namespace' in data) || data.namespace !== _namespace) return; //wrong namespace for msg

            debug("got data from page:", data.cookie_name, data.cookie_val, data.expires_days);

            // Set the data.

            var expires_days = parseInt(data.expires_days, 10);

            // Set in cookie.
            cookieStore.set(data.cookie_name, data.cookie_val, expires_days);

            // Set in local storage.
            localStore.set(data.cookie_name, data.cookie_val);

            var cookieFailed = !cookieStore.has(data.cookie_name);
            var localStorageFailed = !localStore.has(data.cookie_name);

            if (cookieFailed || localStorageFailed) {
                // If we got here, it means we have failed to set the cookie.
                // It can happen in cases third-party cookies or local storage are blocked by the browser.
                // We notify the parent that we failed.
                reportFailureToParent(cookieFailed, localStorageFailed);
            }

            // ping down to page again to update values of xdomain cookie data
            sendDataToParent();
        }

        function reportFailureToParent(cookieFailed, localStorageFailed) {

            if (cookieFailed){
                debug('FAILED TO SET COOKIE');
            }
            if (localStorageFailed){
                debug('FAILED TO SET LOCAL STORAGE');
            }

            var msg = {
                msg_type: 'xdsc_fail',
                cookie_failed: cookieFailed,
                local_storage_failed: localStorageFailed,
                namespace: _namespace
            };

            //postmessage to parent window with data
            window.parent.postMessage(JSON.stringify(msg), _window_origin);
        }

        function sendDataToParent() {

            var data = {
                'playbuzz': cookieStore.get('playbuzz') || localStore.get('playbuzz')
            };

            var msg = {
                cookies: data,
                msg_type: 'xdsc_read',
                namespace: _namespace
            };

            debug("sending data to parent:", data);

            // postmessage to parent window with data
            window.parent.postMessage(JSON.stringify(msg), _window_origin);
        }

        function debug() {
            if (!_debug) return;
            arguments[0] = "[XDOMAIN IFRAME] " + arguments[0];
            console.log.apply(console, arguments);
        }
    }

    var cookieStore = new CookieStore(),
        localStore = new LocalStorageStore(),
        communicator = new ParentCommunicator(cookieStore, localStore);

    communicator.listen();
    communicator.sendDataToParent();

</script>
</body>
</html>
